name: Build Mod Jar

on:
  pull_request:
  push:
    branches:
      - main
    tags:
      - "v*"
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      publish_release:
        description: "Create or update a GitHub release and upload the built JAR"
        type: boolean
        default: false
      release_tag:
        description: "Release tag to use when publish_release is true (e.g., v0.1.0)"
        type: string
        default: ""

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Ensure Gradle wrapper is executable
        run: chmod +x ./gradlew

      - name: Build mod jar
        run: ./gradlew build --no-daemon

      - name: Upload jar artifact
        uses: actions/upload-artifact@v4
        with:
          name: mod-jar
          path: build/libs/*.jar
          if-no-files-found: error

  release:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'release' || startsWith(github.ref, 'refs/tags/v') || (github.event_name == 'workflow_dispatch' && inputs.publish_release)
    permissions:
      contents: write

    steps:
      - name: Validate release tag
        if: github.event_name == 'workflow_dispatch' && inputs.publish_release && inputs.release_tag == ''
        run: |
          echo "release_tag is required when publish_release is true."
          exit 1

      - name: Download jar artifact
        uses: actions/download-artifact@v4
        with:
          name: mod-jar
          path: dist

      - name: Rename jar to match release tag
        env:
          RELEASE_TAG: ${{ github.event.release.tag_name || inputs.release_tag || github.ref_name }}
        run: |
          JAR_PATH=$(ls dist/*.jar | head -n 1)
          MOD_ID=$(basename "$JAR_PATH" | sed -E 's/^([^-]+)-.*/\1/')
          mv "$JAR_PATH" "dist/${MOD_ID}-${RELEASE_TAG}.jar"

      - name: Publish GitHub release assets
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*.jar
          tag_name: ${{ github.event.release.tag_name || inputs.release_tag || github.ref_name }}
          name: ${{ github.event.release.name || inputs.release_tag || github.ref_name }}
